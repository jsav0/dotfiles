#!/bin/bash
#
# n0
# File: vpn_selector.sh
# Description: quick vpn switcher (wireguard) with dmenu or peco
# a110w
#

# debugging
#set -x 
#exec > $HOME/.vpn_selector.log 2>&1

usage() {
echo "
USAGE: ./vpn_selector.sh [OPTIONS]
  Quick vpn menu using wireguard and your choice of dmenu or peco

OPTIONS:
  -d	dmenu, depends on X
  -p	peco, works in a tty
"
exit 1
}

[ $# -eq 0 ] && usage

case $1 in
	-d) SELECTOR="dmenu -c -l 10 -p"
	    ;;
	-p) SELECTOR="peco --initial-index 2 --prompt"
	    ;; 
	*)  usage
	    ;;
esac

LOCATIONS=(
  'Stockholm, Sweden'
  'Gothenburg, Sweden'
  'London, United Kingdom'
  'Miami, United States'
  'Malaga, Spain'
  'Toronto, Canada'
  'Oslo, Norway'
  'Amsterdam, Netherlands'
  'Phuket, Thailand'
  'Cophenhagen, Denmark'
)

disconnect() {
VPN=$(sudo wg show | grep 'vpn\-' | awk '{print $2}')
[[ "$VPN" == "" ]] || sudo wg-quick down "$VPN" > /dev/null 2>&1 
}

connect() {
VPN_LOCATION=$(printf '%s\n' "${LOCATIONS[@]}" | $SELECTOR "Select location: ")
CITY=$(echo $VPN_LOCATION | awk -F, '{print $1}') 
case $CITY in 
	Stockholm ) 	disconnect && sudo wg-quick up vpn-se1 > /dev/null 2>&1 &;; 
	Gothenburg )	disconnect && sudo wg-quick up vpn-se2 > /dev/null 2>&1 &;;
	London )	disconnect && sudo wg-quick up vpn-uk1 > /dev/null 2>&1 &;;
	Miami )		disconnect && sudo wg-quick up vpn-us1 > /dev/null 2>&1 &;; 
	Malaga ) 	disconnect && sudo wg-quick up vpn-es1 > /dev/null 2>&1 &;;
	Toronto ) 	disconnect && sudo wg-quick up vpn-ca1 > /dev/null 2>&1 &;;
	Oslo ) 		disconnect && sudo wg-quick up vpn-no1 > /dev/null 2>&1 &;;
	Amsterdam ) 	disconnect && sudo wg-quick up vpn-nl1 > /dev/null 2>&1 &;;
	Phuket ) 	disconnect && sudo wg-quick up vpn-th1 > /dev/null 2>&1 &;;
	Cophenhagen ) 	disconnect && sudo wg-quick up vpn-dk1 > /dev/null 2>&1 &;;
	* ) exit 1
esac
}

wip() {
  JSON=/tmp/ip_json
  IP=$(curl -s https://canihazip.com/s)
  IP_INFO=$(curl -s https://ipinfo.io/$IP/json --output $JSON)
  CITY=$(cat $JSON | jq .city | tr -d '\"')
  REGION=$(cat $JSON | jq .region | tr -d '\"')
  COUNTRY=$(cat $JSON | jq .country | tr -d '\"')
  printf "$IP $CITY, $REGION, $COUNTRY" > /tmp/public_ip
}

CHOICE=$(printf "connect\ndisconnect" | $SELECTOR "What do you want to do? ")
case $CHOICE in
	connect)	connect && {
				sleep 3
				notify-send "connected to: $VPN_LOCATION"
				wip
			}
			;;
	disconnect)	disconnect;;
	*)		exit 1
esac
