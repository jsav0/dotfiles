#!/bin/bash

array=$(cat /dev/stdin | awk '/http/' | sed 's/.*http/http/g' | awk '{print $1}' | sort)

clear
count=0
IFS=$'\n'
printf "" > ~/.cache/urlhand1
printf "" > ~/.cache/urlhand3
for link in $array
do
	count=$(($count+1))
	echo "$count: $link" >> ~/.cache/urlhand3
	echo "$count:$link" | sed 's|/|\t|g' >> ~/.cache/urlhand1
done

var=$(dmenu -i -p "Select an item" < ~/.cache/urlhand3 | grep -o '[0-9]*')
arg=$(grep "$var:" < ~/.cache/urlhand1 | sed 's|\t|/|g' | sed 's/^[0-9]*://')
handlers=("mpv" "youtube-dl --add-metadata -ic" "youtube-dl --add-metadata -xic" "vimb --no-maximize" "surf" "w3m")
count=0
echo
printf "" > ~/.cache/urlhand2
printf "" > ~/.cache/urlhand4
for item in ${!handlers[*]}
do
	count=$(($count+1))
	echo "$count: ${handlers[$item]}" >> ~/.cache/urlhand4
	echo "$count:${handlers[$item]}" | sed 's|/|\t|g' >> ~/.cache/urlhand2
done

var=$(dmenu -i -p "Select a handler" < ~/.cache/urlhand4 | grep -o '[0-9]*')
hand=$(grep "$var:" < ~/.cache/urlhand2 | sed 's|\t|/|g' | sed 's/^[0-9]*://')
killall mpvlisten
hmpv pause /tmp/mpv-socket
hmpv pause /tmp/mpv-socket2
bash -c "$hand $arg"
mpvlisten /tmp/mpv-socket2 /tmp/mpv-socket &
